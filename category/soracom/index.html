<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="/xmlrpc.php"> <noscript id="aonoscrcss"></noscript>
<title>soracom &#8211; JunkHack</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//www.google.com">
<link rel="dns-prefetch" href="//www.googletagmanager.com">
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
<link rel="alternate" type="application/rss+xml" title="JunkHack &raquo; フィード" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="JunkHack &raquo; コメントフィード" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="JunkHack &raquo; soracom カテゴリーのフィード" href="/category/soracom/feed/">
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=5.8.3" type="text/css" media="all">
<link rel="stylesheet" id="contact-form-7-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_76e12144b6be9bc0a17dd880c5566156.css?ver=5.4.1" type="text/css" media="all">
<link rel="stylesheet" id="contact-form-7-confirm-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_c605b424176e2b3541570e9ebd66830b.css?ver=5.1" type="text/css" media="all">
<link rel="stylesheet" id="wpel-style-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_04d23f0dc44b526ca48d1d564eb7537c.css?ver=2.50" type="text/css" media="all">
<link rel="stylesheet" id="wpfront-scroll-top-css" href="/wp-content/plugins/wpfront-scroll-top/css/wpfront-scroll-top.min.css?ver=2.0.7.08086" type="text/css" media="all">
<link rel="stylesheet" id="related-frontend-css-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_ce8bbdb7cabcf5f0fa8d28d9868b7638.css?ver=0.1.0" type="text/css" media="all">
<link rel="stylesheet" id="hew-fonts-css" href="https://fonts.googleapis.com/css?family=Open+Sans%3A400%2C600%2C700%2C400italic%2C600italic%2C700italic%7CNoto+Serif%3A400%2C700%2C400italic%2C700italic&#038;subset=latin" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_c14dd6e84e694a66c7e27f11220ed49a.css?ver=3.4.1" type="text/css" media="all">
<link rel="stylesheet" id="hew-style-css" href="/wp-content/cache/autoptimize/css/autoptimize_single_923a46d76606f1b43e3f3639ca289d5f.css?ver=5.8.3" type="text/css" media="all"> <script type="text/javascript" src="/wp-content/plugins/jquery-manager/assets/js/jquery-3.5.1.min.js" id="jquery-core-js"></script> <script type="text/javascript" src="/wp-content/plugins/jquery-manager/assets/js/jquery-migrate-3.3.0.min.js" id="jquery-migrate-js"></script>  <script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-199105184-1" id="google_gtagjs-js" async></script> <script type="text/javascript" id="google_gtagjs-js-after">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}
gtag('set', 'linker', {"domains":["hack.gpl.jp"]} );
gtag("js", new Date());
gtag("set", "developer_id.dZTNiMT", true);
gtag("config", "UA-199105184-1", {"anonymize_ip":true});</script> <link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/categories/72">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml">
<meta name="generator" content="WordPress 5.8.3">
<meta name="generator" content="Site Kit by Google 1.48.1">
<meta name="google-adsense-platform-account" content="ca-host-pub-2644536267352236">
<meta name="google-adsense-platform-domain" content="sitekit.withgoogle.com">  <script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2711753458083215" crossorigin="anonymous" type="text/javascript"></script> </head>  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161935417-3"></script> <script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161935417-3');</script> <body class="archive category category-soracom category-72 has-sidebar has-header-image">
<div id="page" class="hfeed site">
<div id="widgets-wrapper" class="hide"><div id="secondary" class="wrap top-widget-area" role="complementary"><div id="sidebar-4" class="widget-area" role="complementary"><aside id="block-2" class="widget widget_block"><script async src="https://cse.google.com/cse.js?cx=df8210082ba786774"></script> <div class="gcse-search"></div></aside></div></div></div> <a class="skip-link screen-reader-text" href="#content">コンテンツへ移動</a><header id="masthead" class="site-header" role="banner"> <a class="site-logo" href="/" title="JunkHack" rel="home noopener noreferrer" data-wpel-link="internal"> <noscript><img src="https://secure.gravatar.com/avatar/997681319c3cbb0bdcca95770d5edaa6/?s=80&#038;d=mm" width="80" height="80" alt="" class="no-grav header-image"></noscript>
<img src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2080%2080%22%3E%3C/svg%3E" data-src="https://secure.gravatar.com/avatar/997681319c3cbb0bdcca95770d5edaa6/?s=80&#038;d=mm" width="80" height="80" alt="" class="lazyload no-grav header-image"> </a><div class="site-branding">
<h1 class="site-title"><a href="/" rel="home noopener noreferrer" data-wpel-link="internal">JunkHack</a></h1>
<h2 class="site-description">アリエクでポチった JUNKHACK</h2>
</div>
<nav id="site-navigation" class="main-navigation" role="navigation"> <button class="menu-toggle toggle-button"><span class="screen-reader-text">メインメニュー</span></button><div class="menu-new-menu-container"><ul id="menu-new-menu" class="menu">
<li id="menu-item-10686" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-10686"><a href="/list/" data-wpel-link="internal" rel="noopener noreferrer">List</a></li>
<li id="menu-item-11016" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-11016"><a href="/mail/" data-wpel-link="internal" rel="noopener noreferrer">CONTACT</a></li>
<li id="menu-item-10671" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-10671"><a href="https://jh.gpl.jp/" data-wpel-link="external" target="_blank" rel="external noopener noreferrer" class="wpel-icon-right">Mirror Netlify<span class="wpel-icon wpel-image wpel-icon-1"></span></a></li>
</ul></div></nav><div class="toggle-wrapper"> <a href="#" class="widgets-toggle toggle-button" title="ウィジェット"> <span class="screen-reader-text">ウィジェット</span> </a>
</div></header><div id="content" class="site-content"><section id="primary" class="content-area"><main id="main" class="site-main" role="main"><header class="page-header"><h1 class="page-title">カテゴリー: <span>soracom</span>
</h1></header><article id="post-2196" class="post-2196 post type-post status-publish format-standard hentry category-orangepi category-orangepipc category-soracom"><div class="entry-wrapper">
<header class="entry-header"> <span class="entry-format theme-genericon"></span><div class="entry-meta"> <span class="posted-on">投稿日: <a href="/2016/05/29/iot1/" rel="bookmark noopener noreferrer" data-wpel-link="internal"><time class="entry-date published updated" datetime="2016-05-29T18:06:46+09:00">2016年5月29日</time></a> </span><span class="posted-on">更新日:2016年5月29日</span> <span class="categories"> <a href="/category/orangepi/" rel="category tag noopener noreferrer" data-wpel-link="internal">OrangePi</a>, <a href="/category/orangepipc/" rel="category tag noopener noreferrer" data-wpel-link="internal">OrangePiPC</a>, <a href="/category/soracom/" rel="category tag noopener noreferrer" data-wpel-link="internal">soracom</a></span>
</div>
<h1 class="entry-title"><a href="/2016/05/29/iot1/" rel="bookmark noopener noreferrer" data-wpel-link="internal">Soracom で IoT はじめました</a></h1></header><div class="entry-content">
<p>移動している中、IoT データを送信したいなと。この場合、WIFI がないんですよね。</p>
<p>IoT デバイスからはブルートゥースやWiFi でネット経由へデータは出せるのですが、どこでも、投げたいので Soracom Air の SIM を使い始めました。</p>
<p>&#160;</p>
<p><a href="https://soracom.jp/" target="_blank" rel="noopener noreferrer external" data-wpel-link="external"><noscript><img title="soracom_air" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom_air" src="/wp-content/uploads/2016/05/soracom_air.png" width="332" height="107"></noscript>
<img class="lazyload" title="soracom_air" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom_air" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20332%20107%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracom_air.png" width="332" height="107"></a></p>
<p>電波が届く範囲なら、どこでも、データを投げて記録が取れるということで、まずは格安の Linux ボードで Soracom に接続し単純なデータを送信するところまでやってみました。</p>
<p>今回の目標は、「Soracom 経由で、Linux の CPU&#160; 温度を ThingSpeak に送信しグラフ化させる」のが目標です。</p>
<p>ThingSpeak とは、IoT データを記録し、グラフ表示するWEBサービスです。このサービスは、<a href="https://github.com/iobridge/ThingSpeak" target="_blank" rel="noopener noreferrer external" data-wpel-link="external" class="wpel-icon-right">自前でも構築可能<span class="wpel-icon wpel-image wpel-icon-1"></span></a>ですので最終的にはデータ蓄積するサーバを構築しても良さそうです。</p>
<p>これが実現できると、以下のようなグラフがリアルタイムで記録されます。</p>
<p></p>
<noscript><img title="test_-_ThingSpeak" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="test_-_ThingSpeak" src="/wp-content/uploads/2016/05/test__thingspeak.png" width="475" height="325"></noscript>
<img class="lazyload" title="test_-_ThingSpeak" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="test_-_ThingSpeak" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20475%20325%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/test__thingspeak.png" width="475" height="325"><p>これを実現するためには、以下のような準備が必要です。</p>
<p>&#160;</p>
<p>・Linux ボードの準備と、その OS の選定</p>
<p>・soracom sim の準備と Linux 側から PPP 接続するための USB モデムの設定</p>
<p>・CPU 温度を取得して thingspeak にデータを投げるスクリプト</p>
<p>・thingspeak 側のアカウントなどの準備</p>
<p>最終的には、自立して稼動させたいので電源周りをどうしようか課題は残ります。</p>
<p>・独立した電源まわりの準備</p>
<p>・電源に充電させる仕組</p>
<p>&#160;</p>
<p>今回 Soracom 経由でインターネットに接続に利用する母艦の Linux ボードは、Orange Pi PC です。ラズベリーパイは、価格は5000円前後しますので屋外でぶっ壊れたときにショックなので、コストパフォーマンスが良い Orange Pi でやることに。</p>
<p>&#160;</p>
<p><a href="http://www.orangepi.org/" target="_blank" rel="noopener noreferrer external" data-wpel-link="external" class="wpel-icon-right">Orange Pi<span class="wpel-icon wpel-image wpel-icon-1"></span></a> シリーズは、過去にも紹介していますが、種類が結構あります。最近発売された WiFi が付いてさらに格安の <a href="http://www.cnx-software.com/2016/05/09/orange-pi-lite-development-board-with-wifi-is-now-available-for-12/" target="_blank" rel="noopener noreferrer external" data-wpel-link="external" class="wpel-icon-right">Orange Pi Lite<span class="wpel-icon wpel-image wpel-icon-1"></span></a> というものもあります。こちらは約1700円程度で購入できます。人柱的に、このボードも入手中ですので、到着したら改めてレポートしてみたいと思います。</p>
<p>&#160;</p>
<p>さて、soracom と 3G 通信するためにモデムが必要ですが、LGエレクトロニクス・ジャパン製で、OEM では DoCoMo から出ている L-05A を使いました。amazon で中古でゲットしました。osx でも使えるというのがぽちったポイントでした。</p>
<p></p>
<noscript><img title="IMG_2782" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="IMG_2782" src="/wp-content/uploads/2016/05/img_2782.jpg" width="640" height="480"></noscript>
<img class="lazyload" title="IMG_2782" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="IMG_2782" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20640%20480%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/img_2782.jpg" width="640" height="480"><p>最終的には、もう少しコンパクトにして電池を組み込む予定です。応用すれば GPS モジュールを接続して、位置を補足する IoT デバイスも作れそうです。</p>
<p>&#160;</p>
<p>soracom の管理コンソールからは、データ転送量も見えて管理しやすそうです。</p>
<p></p>
<noscript><img title="SORACOM_ユーザーコンソール" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="SORACOM_ユーザーコンソール" src="/wp-content/uploads/2016/05/soracom_.png" width="490" height="480"></noscript>
<img class="lazyload" title="SORACOM_ユーザーコンソール" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="SORACOM_ユーザーコンソール" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20490%20480%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracom_.png" width="490" height="480"><p>では、順にポイントと勘所をご紹介します。</p>
<p>&#160;</p>
<h3>Linux ボードの準備と、その OS の選定</h3>
<p>&#160;</p>
<p>まず、母艦の準備です。Orange PI PC を用意しました。</p>
<p><a title="http://www.orangepi.org/orangepipc/" href="http://www.orangepi.org/orangepipc/" target="_blank" rel="noopener noreferrer external" data-wpel-link="external" class="wpel-icon-right">http://www.orangepi.org/orangepipc/<span class="wpel-icon wpel-image wpel-icon-1"></span></a></p>
<p>オフィシャルサイトから、メーカー直販の aliexpress の販売サイトにいけます。メモリ512M でも要求は満たしますので、one とか lite でもよいかと思います。</p>
<p></p>
<noscript><img title="orangepipc" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="orangepipc" src="/wp-content/uploads/2016/05/orangepipc.png" width="530" height="339"></noscript>
<img class="lazyload" title="orangepipc" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="orangepipc" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20530%20339%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/orangepipc.png" width="530" height="339"><p>OS は、ARMBIAN というものを今回は採用。Debian 系の OS となります。</p>
<p><a title="http://www.armbian.com/orange-pi-pc/" href="http://www.armbian.com/orange-pi-pc/" target="_blank" rel="noopener noreferrer external" data-wpel-link="external" class="wpel-icon-right">http://www.armbian.com/orange-pi-pc/<span class="wpel-icon wpel-image wpel-icon-1"></span></a></p>
<p>8GB の SDCard に書き込みし、IP を固定しておきます。電源は、ラズベリーパイとは違い、マイクロUSBではありませんので、別途 4mm で、センターピンが 1.7mm のDC ジャックを用意しておきます。これは、PSP用USB充電ケーブルと同じなので、100円均一などでもゲットできるかと思います。自分は、ジャックを別途購入し電源ケーブルは自作です。</p>
<p>なお、今回はCPU ヒートシンクとファンを実装しました。設定によっては、ヒートシンクのみや、無しでも運用可能です。</p>
<p>設定によりますが、最高で100度近くまで CPU が発熱しますので寿命が短くなるか壊れる事もありますので注意が必要です。</p>
<p>&#160;</p>
<blockquote>
<p>過去にヒートシンクを付けた記事を書いていますのでご参考に。</p>
<p><a href="/2016/02/14/orangepi-one-%E3%81%ABfan-%E3%82%92%E4%BB%98%E3%81%91%E3%81%A6%E5%85%A8%E9%96%8B%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF/" target="_blank" rel="noopener noreferrer" data-wpel-link="internal">OrangePi One にFan を付けて全開ベンチマーク</a></p>
</blockquote>
<p>&#160;</p>
<h3>soracom sim の準備</h3>
<p>次は、soracom の sim を USB モデムで使うための準備です。USB モデムは、今回中古で L-05A を購入しておきました。</p>
<p>まずは、soracom の sim をアクティベートしておきます。管理コンソールよりログインし、sim の操作で可能です。</p>
<p></p>
<noscript><img title="soracomlogin" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracomlogin" src="/wp-content/uploads/2016/05/soracomlogin.png" width="631" height="353"></noscript>
<img class="lazyload" title="soracomlogin" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracomlogin" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20631%20353%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracomlogin.png" width="631" height="353"><p>&#160;</p>
<p>なかなか簡単操作です。すばらしい。速度クラスは、とりあえず s1.minimum にしておきました。</p>
<p></p>
<noscript><img title="soracom2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom2" src="/wp-content/uploads/2016/05/soracom2.png" width="630" height="401"></noscript>
<img class="lazyload" title="soracom2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom2" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20630%20401%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracom2.png" width="630" height="401"><p>データ通信量が 150MiB を超えたらメールしてくるようにしておきました。有効期限なども設定できるようですね。キャリアになった気分です。</p>
<p>&#160;</p>
<h3>Linux 側から PPP 接続するための USB モデムの設定</h3>
<p>次に、sim を USB モデムに差込、Linux 機に取り付けます。デフォルトでは、CD-ROMドライブとして認識されるようですが、これは AT コマンドで挙動を制御できるようです。/dev/sr0 を一度イジェクトしておきます。</p>
<p>&#160;</p>
<pre class="brush: cpp; gutter: false; toolbar: false; collapse: true; auto-links: false; smart-tabs: false;">[root@opi 22:34:04 ~]# eject /dev/sr0
eject: unable to eject, last error: Invalid argument
[root@opi 22:34:12 ~]# ll /dev/ | grep ACM
crw-rw---- 1 root dialout 166,   0 May 26 22:34 ttyACM0
crw-rw---- 1 root dialout 166,   1 May 26 22:34 ttyACM1
crw-rw---- 1 root dialout 166,   2 May 26 22:34 ttyACM2
[root@opi 22:34:30 ~]# </pre>
<p>&#160;</p>
<p>そして、AT コマンドで CD-ROM ドライブとして認識しないよう設定しておきます。</p>
<p>&#160;</p>
<pre class="brush: cpp; gutter: false; toolbar: false; collapse: true; auto-links: false; smart-tabs: false;">[root@opi 22:34:49 ~]# screen /dev/ttyACM0
ATZ
OK
AT%USBMODEM=0
[0] MODEM DRIVER

OK
ATZ0
OK</pre>
<p>&#160;</p>
<p>あとは、ppp 接続するための設定をしておきます。wvdial パッケージを導入しておきます。</p>
<p>&#160;</p>
<p>[root@opi 15:57:33 log]# apt-get install wvdial</p>
<p>&#160;</p>
<p>設定です。</p>
<p>&#160;</p>
<pre class="brush: cpp; gutter: false; toolbar: false; collapse: true; auto-links: false; smart-tabs: false;">----- /etc/wvdial.conf 
[Dialer Defaults]
Init1 = ATZ
Init2 = ATQ0 V1 E1 S0=0 &amp;C1 &amp;D2
Init3 = AT+CGDCONT=1,&quot;IP&quot;,&quot;soracom.io&quot;
Dial Attempts = 3
Modem Type = Analog Modem
Dial Command = ATD
Stupid Mode = yes
Baud = 460800
New PPPD = yes
Modem = /dev/ttyACM0
ISDN = 0
Phone = *99***1#
APN = soracom.io
Username = sora
Password = sora
Carrier Check = no
Auto DNS = 1
Check Def Route = 1</pre>
<p>&#160;</p>
<p>systemctl で起動できるよう設定しておきます。システム起動時に起動する設定にはまだしていません。enable にするだけですが。</p>
<p>&#160;</p>
<pre class="brush: cpp; gutter: false; toolbar: false; collapse: true; auto-links: false; smart-tabs: false;">---- /etc/systemd/system/wvdial.service
[Unit]
Description=wvdial service
Wants=network.target

[Service]
Type=simple
ExecStartPre=/sbin/route del default gw 192.168.1.1
ExecStopPost=/sbin/route add default gw 192.168.1.1
ExecStart=/usr/bin/wvdial
ExecStop=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target</pre>
<p>&#160;</p>
<p>以上で設定は終わり。接続の確認をしておきます。</p>
<p>&#160;</p>
<p>[root@opi 16:02:24 log]# systemctl start wvdial</p>
<p>&#160;</p>
<p>動作したかどうかは、status で見てみます。USB モデムの LED が緑から青色になっていると思います。</p>
<p>&#160;</p>
<p>[root@opi 16:03:29 log]# systemctl status wvdial</p>
<p>::</p>
<p>May 28 16:02:37 orangepipc pppd[19681]: local&#160; IP address 10.182.126.96<br> <br>May 28 16:02:37 orangepipc pppd[19681]: remote IP address 10.64.64.64</p>
<p>May 28 16:02:37 orangepipc pppd[19681]: primary&#160;&#160; DNS address 100.127.0.53</p>
<p>May 28 16:02:37 orangepipc pppd[19681]: secondary DNS address 100.127.1.53</p>
<p>May 28 16:02:37 orangepipc wvdial[19679]: &#8211;&gt; local&#160; IP address 10.182.126.96</p>
<p>May 28 16:02:37 orangepipc wvdial[19679]: &#8211;&gt; remote IP address 10.64.64.64</p>
<p>May 28 16:02:37 orangepipc wvdial[19679]: &#8211;&gt; primary&#160;&#160; DNS address 100.127.0.53</p>
<p>May 28 16:02:37 orangepipc wvdial[19679]: &#8211;&gt; secondary DNS address 100.127.1.53</p>
<p>&#160;</p>
<p>プライベートなクラスAの IP が割り振られるようですね。ppp0 の状態を見ると以下のようです。</p>
<p>&#160;</p>
<p>[root@opi 16:07:38 log]# ifconfig ppp0<br> <br>ppp0&#160;&#160;&#160;&#160;&#160; Link encap:Point-to-Point Protocol&#160; <br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; inet addr:10.182.126.96&#160; P-t-P:10.64.64.64&#160; Mask:255.255.255.255</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; UP POINTOPOINT RUNNING NOARP MULTICAST&#160; MTU:1500&#160; Metric:1</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RX packets:83 errors:0 dropped:0 overruns:0 frame:0</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TX packets:83 errors:0 dropped:0 overruns:0 carrier:0</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; collisions:0 txqueuelen:3</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RX bytes:10339 (10.0 KiB)&#160; TX bytes:14232 (13.8 KiB)</p>
<p>[root@opi 16:07:43 log]#</p>
<p>&#160;</p>
<p>eth0 も繋がっていますが、ルーティング情報が以下のようになっていれば、ppp0 経由でインターネットに接続可能です。</p>
<p>&#160;</p>
<p>[root@opi 16:09:42 log]# route -n<br> <br>Kernel IP routing table</p>
<p>Destination&#160;&#160;&#160;&#160; Gateway&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Genmask&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Flags Metric Ref&#160;&#160;&#160; Use Iface</p>
<p>0.0.0.0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; U&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0 ppp0</p>
<p>10.64.64.64&#160;&#160;&#160;&#160; 0.0.0.0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 255.255.255.255 UH&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0 ppp0</p>
<p>192.168.1.0&#160;&#160;&#160;&#160; 0.0.0.0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 255.255.255.0&#160;&#160; U&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0 eth0</p>
<p>[root@opi 16:09:44 log]#</p>
<p>&#160;</p>
<p>google までトレースルートしてみましょう。</p>
<p>&#160;</p>
<p>[root@opi 16:11:03 log]# traceroute www.google.com<br> <br>traceroute to www.google.com (172.217.25.68), 30 hops max, 60 byte packets</p>
<p>1&#160; ec2-175-41-192-232.ap-northeast-1.compute.amazonaws.com (175.41.192.232)&#160; 97.266 ms&#160; 106.862 ms&#160; 106.923 ms</p>
<p>2&#160; 27.0.0.71 (27.0.0.71)&#160; 116.491 ms&#160; 136.763 ms&#160; 136.841 ms</p>
<p>3&#160; 52.95.30.79 (52.95.30.79)&#160; 146.299 ms 52.95.30.77 (52.95.30.77)&#160; 156.162 ms 52.95.30.83 (52.95.30.83)&#160; 166.192 ms</p>
<p>4&#160; 52.95.30.150 (52.95.30.150)&#160; 166.290 ms 52.95.30.144 (52.95.30.144)&#160; 166.450 ms 52.95.30.150 (52.95.30.150)&#160; 205.754 ms</p>
<p>5&#160; 52.95.216.117 (52.95.216.117)&#160; 185.674 ms&#160; 195.447 ms&#160; 205.659 ms</p>
<p>6&#160; 216.239.54.13 (216.239.54.13)&#160; 215.216 ms&#160; 79.420 ms&#160; 97.653 ms</p>
<p>7&#160; 108.170.233.79 (108.170.233.79)&#160; 117.188 ms&#160; 127.330 ms&#160; 146.963 ms</p>
<p>8&#160; nrt13s50-in-f4.1e100.net (172.217.25.68)&#160; 156.867 ms&#160; 187.089 ms&#160; 196.809 ms</p>
<p>[root@opi 16:11:26 log]#</p>
<p>&#160;</p>
<p>soracom のコンソールで 1 時間ごとの使用量を見ると、記録されているようです。</p>
<p></p>
<noscript><img title="soracom1h" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom1h" src="/wp-content/uploads/2016/05/soracom1h.png" width="511" height="480"></noscript>
<img class="lazyload" title="soracom1h" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom1h" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20511%20480%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracom1h.png" width="511" height="480"><p>&#160;</p>
<h3>CPU 温度を取得して thingspeak にデータを投げるスクリプト</h3>
<p>次は、cpu 温度を取得し、データを飛ばすプログラムを作ります。python で作りました。</p>
<p>&#160;</p>
<pre class="brush: cpp; gutter: false; toolbar: false; collapse: true; auto-links: false; smart-tabs: false;">#!/usr/bin/python
# coding: utf-8

import requests
#from time import sleep
import time
api_key='your api key'

def sender():
  while True:
    f = open(&quot;/sys/class/thermal/thermal_zone0/temp&quot;,&quot;r&quot;)
    t = f.read()
    payload = {'api_key': api_key, 'field1': str(t)}
    f.close()
    print &quot;CPU Temp is:%s&quot;%t ,
    r = requests.get('http://52.7.53.111/update', params=payload)
    print &quot;Result: &quot;, r.text
    time.sleep(1.0)

def main():
    sender()

if __name__ == '__main__':
  main()</pre>
<p>&#160;</p>
<p>簡単にプログラムを補足します。</p>
<p>python のライブラリを以下のように入れておきます。</p>
<p>&#160;</p>
<p># apt-get install python-dev<br> <br># apt-get install python-pip</p>
<p># pip install requests</p>
<p>&#160;</p>
<p>api_key には、書き込みのAPI Key を入れておきます。</p>
<p>&#160;</p>
<p></p>
<noscript><img title="Channels_-_ThingSpeak" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="Channels_-_ThingSpeak" src="/wp-content/uploads/2016/05/channels__thingspeak.png" width="475" height="303"></noscript>
<img class="lazyload" title="Channels_-_ThingSpeak" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="Channels_-_ThingSpeak" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20475%20303%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/channels__thingspeak.png" width="475" height="303"><p>データをhttps (SSL)経由の post で投げるとパケットが消費されるので、ここでは、get で投げています。</p>
<p>api.thingspeak.com を名前解決すると以下のように２つIPが出ますので、ここでは片方のIPを指定しています。相手側の事情でIP が変わることもあるかもしれません。</p>
<p>&#160;</p>
<p># dig api.thingspeak.com</p>
<p>::</p>
<p>;; ANSWER SECTION:<br> <br>api.thingspeak.com.&#160;&#160;&#160; 60&#160;&#160;&#160; IN&#160;&#160;&#160; A&#160;&#160;&#160; 52.200.157.52</p>
<p>api.thingspeak.com.&#160;&#160;&#160; 60&#160;&#160;&#160; IN&#160;&#160;&#160; A&#160;&#160;&#160; 52.7.53.111</p>
<p>&#160;</p>
<p>プログラムを以下のように実行します。</p>
<p>&#160;</p>
<p>[root@opi 18:20:46 work]# python t.py</p>
<p>&#160;</p>
<p>実行すると、以下のようになります。</p>
<p>&#160;</p>
<p>[root@opi 18:20:46 work]# python t.py<br> <br>CPU Temp is:38</p>
<p>Result:&#160; 401</p>
<p>CPU Temp is:38</p>
<p>Result:&#160; 0</p>
<p>CPU Temp is:38</p>
<p>Result:&#160; 0</p>
<p>CPU Temp is:38</p>
<p>Result:&#160; 0</p>
<p>CPU Temp is:38</p>
<p>Result:&#160; 0</p>
<p>&#160;</p>
<p>CPU の温度を上げるため、負荷を UnixBench でかけてみます。</p>
<p>&#160;</p>
<p>[root@opi 18:08:33 UnixBench]# ./Run -c 4</p>
<p>&#160;</p>
<p>グラフ表示は、こんな感じで出ています。</p>
<p></p>
<noscript><img title="test_-_ThingSpeak 2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="test_-_ThingSpeak 2" src="/wp-content/uploads/2016/05/test__thingspeak2.png" width="478" height="325"></noscript>
<img class="lazyload" title="test_-_ThingSpeak 2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="test_-_ThingSpeak 2" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20478%20325%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/test__thingspeak2.png" width="478" height="325"><p>CPU 温度がこれで1秒ごとに記録されていきますが、600秒に一度くらいでいいので、修正し、ログオフ後もスクリプトが動作するよう以下のように nohup で実行しておきます。</p>
<p>&#160;</p>
<p>[root@opi 18:34:08 work]# nohup python t.py &amp;<br> <br>[1] 13673</p>
<p>[root@opi 18:34:28 work]# nohup: ignoring input and appending output to ‘nohup.out’</p>
<p>[root@opi 18:34:32 work]# ps axu | grep python<br> <br>::</p>
<p>root&#160;&#160;&#160;&#160; 13673&#160; 4.1&#160; 0.8&#160; 13796&#160; 8428 pts/0&#160;&#160;&#160; S&#160;&#160;&#160; 18:34&#160;&#160; 0:00 python t.py</p>
<p>&#160;</p>
<p>なお、今のところ soracom の接続料金は 119 円のようです。</p>
<p></p>
<noscript><img title="soracompay" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracompay" src="/wp-content/uploads/2016/05/soracompay.png" width="623" height="234"></noscript>
<img class="lazyload" title="soracompay" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracompay" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20623%20234%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracompay.png" width="623" height="234"><p>&#160;</p>
<p>しばらく、CPU 温度を記録させてテストしてみることに。GPIO からセンサーを取り付ければ、外気温や湿度、明るさや、PM2.5 など記録したいものを投げれます。</p>
<p>ちなみに、1日経過後、課金は以下のようです。</p>
<p></p>
<noscript><img title="soracom_2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom_2" src="/wp-content/uploads/2016/05/soracom_2.png" width="631" height="232"></noscript>
<img class="lazyload" title="soracom_2" style="float:none;margin-left:auto;display:block;margin-right:auto;border-width:0;" border="0" alt="soracom_2" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20631%20232%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2016/05/soracom_2.png" width="631" height="232"><p>この母艦を利用し、WiFi 経由で センサーデバイスを作るのが実用的かもしれません。組み合わはいろいろありますね。</p>
<p align="left">この続きはまたの機会に。</p>
<p align="center">&#160;</p>
<div align="center"><table cellspacing="0" cellpadding="2" width="400" align="center" border="0"><tbody><tr>
<td valign="top" width="200"><a href="http://s.click.aliexpress.com/e/YrvvZz7IQ" target="_blank" rel="noopener noreferrer external" data-wpel-link="external"><noscript><img style="float:none;margin-left:auto;display:block;margin-right:auto;" src="http://g03.a.alicdn.com/kf/HTB1yKxVMFXXXXcyXpXXq6xXFXXX7/Latest-font-b-Raspberry-b-font-font-b-Pi-b-font-2-Model-B-B-Plus.jpg_220x220.jpg"></noscript>
<img class="lazyload" style="float:none;margin-left:auto;display:block;margin-right:auto;" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="http://g03.a.alicdn.com/kf/HTB1yKxVMFXXXXcyXpXXq6xXFXXX7/Latest-font-b-Raspberry-b-font-font-b-Pi-b-font-2-Model-B-B-Plus.jpg_220x220.jpg"><span style="display:block;"><font color="#669966"></font></span></a></td>
<td valign="top" width="200"><a href="http://s.click.aliexpress.com/e/RbuJaiaU7" target="_blank" rel="noopener noreferrer external" data-wpel-link="external"><noscript><img src="http://g03.a.alicdn.com/kf/HTB11roEKXXXXXaEXXXXq6xXFXXX0/-2PCS-with-Tracking-Number-and-Free-shipping-font-b-ESP8266-b-font-serial-WIFI-Witty.jpg_220x220.jpg" width="269" height="221"></noscript>
<img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20269%20221%22%3E%3C/svg%3E" data-src="http://g03.a.alicdn.com/kf/HTB11roEKXXXXXaEXXXXq6xXFXXX0/-2PCS-with-Tracking-Number-and-Free-shipping-font-b-ESP8266-b-font-serial-WIFI-Witty.jpg_220x220.jpg" width="269" height="221"><span style="display:block;"><font color="#669966"></font></span></a></td>
</tr></tbody></table></div>
</div>
<footer class="entry-footer"></footer>
</div></article></main></section></div>
<footer id="colophon" class="site-footer wrap" role="contentinfo"><div class="site-info"> Copyleft - all rights reversed. <span class="sep"> | </span> JunkHack 2011 - 2022 <span class="sep"> | </span> <a href="/about-junkhack/" data-wpel-link="internal" rel="noopener noreferrer">運営者情報<span class="gf"></span></a><span class="sep"> | </span> <a href="/mail/" data-wpel-link="internal" rel="noopener noreferrer">お問い合わせ<span class="gf"></span></a><span class="sep"> | </span> <a href="/privacy/" data-wpel-link="internal" rel="noopener noreferrer">プライバシーポリシー<span class="gf"></span></a>
</div></footer>
</div>
<div id="wpfront-scroll-top-container"> <noscript><img src="/wp-content/plugins/wpfront-scroll-top/images/icons/1.png" alt=""></noscript>
<img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="/wp-content/plugins/wpfront-scroll-top/images/icons/1.png" alt="">
</div> <script type="text/javascript">function wpfront_scroll_top_init() {
                if (typeof wpfront_scroll_top === "function" && typeof jQuery !== "undefined") {
                    wpfront_scroll_top({"scroll_offset":100,"button_width":0,"button_height":0,"button_opacity":0.8,"button_fade_duration":200,"scroll_duration":400,"location":1,"marginX":20,"marginY":20,"hide_iframe":false,"auto_hide":false,"auto_hide_after":2,"button_action":"top","button_action_element_selector":"","button_action_container_selector":"html, body","button_action_element_offset":0});
                } else {
                    setTimeout(wpfront_scroll_top_init, 100);
                }
            }
            wpfront_scroll_top_init();</script> <noscript><style>.lazyload{display:none;}</style></noscript>
<script data-noptimize="1">window.lazySizesConfig=window.lazySizesConfig||{};window.lazySizesConfig.loadMode=1;</script><script async data-noptimize="1" src="/wp-content/plugins/autoptimize/classes/external/js/lazysizes.min.js?ao_version=2.9.5"></script><script type="text/javascript" src="/wp-includes/js/dist/vendor/regenerator-runtime.min.js?ver=0.13.7" id="regenerator-runtime-js"></script> <script type="text/javascript" src="/wp-includes/js/dist/vendor/wp-polyfill.min.js?ver=3.15.0" id="wp-polyfill-js"></script> <script type="text/javascript" id="contact-form-7-js-extra">var wpcf7 = {"api":{"root":"\/wp-json\/","namespace":"contact-form-7\/v1"},"cached":"1"};</script> <script type="text/javascript" id="google-invisible-recaptcha-js-before">var renderInvisibleReCaptcha = function() {

    for (var i = 0; i < document.forms.length; ++i) {
        var form = document.forms[i];
        var holder = form.querySelector('.inv-recaptcha-holder');

        if (null === holder) continue;
		holder.innerHTML = '';

         (function(frm){
			var cf7SubmitElm = frm.querySelector('.wpcf7-submit');
            var holderId = grecaptcha.render(holder,{
                'sitekey': '6Lf2z80ZAAAAAJpiFOn2Cix-QJQkaiC7uBA6NCkS', 'size': 'invisible', 'badge' : 'inline',
                'callback' : function (recaptchaToken) {
					if((null !== cf7SubmitElm) && (typeof jQuery != 'undefined')){jQuery(frm).submit();grecaptcha.reset(holderId);return;}
					 HTMLFormElement.prototype.submit.call(frm);
                },
                'expired-callback' : function(){grecaptcha.reset(holderId);}
            });

			if(null !== cf7SubmitElm && (typeof jQuery != 'undefined') ){
				jQuery(cf7SubmitElm).off('click').on('click', function(clickEvt){
					clickEvt.preventDefault();
					grecaptcha.execute(holderId);
				});
			}
			else
			{
				frm.onsubmit = function (evt){evt.preventDefault();grecaptcha.execute(holderId);};
			}


        })(form);
    }
};</script> <script type="text/javascript" async defer src="https://www.google.com/recaptcha/api.js?onload=renderInvisibleReCaptcha&#038;render=explicit&#038;hl=ja" id="google-invisible-recaptcha-js"></script> <script type="text/javascript" src="/wp-content/themes/hew-wpcom/js/contact.js?ver=20210612" id="sendmail-js"></script> <script type="text/javascript" src="https://www.google.com/recaptcha/api.js?render=6Lf2z80ZAAAAAJpiFOn2Cix-QJQkaiC7uBA6NCkS&#038;ver=3.0" id="google-recaptcha-js"></script> <script type="text/javascript" id="wpcf7-recaptcha-js-extra">var wpcf7_recaptcha = {"sitekey":"6Lf2z80ZAAAAAJpiFOn2Cix-QJQkaiC7uBA6NCkS","actions":{"homepage":"homepage","contactform":"contactform"}};</script> <script defer src="/wp-content/cache/autoptimize/js/autoptimize_b6c6c7d2c47bd5f86199fb6f5207fc2e.js"></script>
</body>
</html>